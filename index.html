<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ticket</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  font-family: "Courier New", Courier, monospace;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  background: #f0f0f0;
  gap: 20px;
}
.pdf {
  width: 849px;
  height: 1280px;
  background: #fff;
  padding: 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: absolute;
  left: -9999px; /* screen se bahar */
  top: 0;
}
.top_code {
  font-size: 44px;
  font-weight: 500;
  margin: 10px 0;
}
img.qr {
  width: auto;
  height: 540px;
  margin: 10px 0;
}
.price {
  text-align: center;
  padding-top: 15px;
}
.price span {
  display: inline-block;
}
.details {
  padding-top: 20px;
  width: 100%;
  font-size: 40px;
  line-height: 1.5;
}
.controls {
  max-width: 400px;
  width: 400px;
}
main{
  display: flex;
  flex-direction: column;
  padding-top: 100px;
  padding-bottom: 100px;
  align-items: center;
  justify-content: center;
}
</style>
</head>
<body>

<main class="d-flex gap-4 ">
  <div class="pdf" id="pdfRoot" style="visibility: hidden;">
    <p class="top_code" id="topCode">32-001-2507-02810-0011-0</p>
    <img class="qr" src="./img/qrcode.jpeg" alt="QR Code" />
    <div class="price">
      <p style="font-size:54px; font-weight: bold;">
        <span id="ticketPrice">120</span> 
        <span style="font-family: Arial, Helvetica, sans-serif; font-size:45px; font-weight:400;">PKR</span>
      </p>
      <p class="pera_ticket" style="font-size:38px;"> <span id="ticketPriceText">120</span>-Single Ticket Adult</p>
    </div>
    <div class="details">
      <p id="pDate">Purchase Date: 13/07/2025</p>
      <p id="pTime">08:17:15</p>
      <p>Valid Until <span style="padding-left: 24px;">:</span> <span id="untilDate">13/07/2025</span> <span id="untilTime">10:17</span></p>
      <p>Sam Id<span style="padding-left: 169px;">:</span> <span id="samId">05220409</span></p>
      <p>Kiosk/Term No<span style="padding-left: 2px;">:</span> <span id="kioskNo">1230000001/10122</span></p>
    </div>
  </div>

  <aside class="controls">
    <div class="card p-3 shadow-sm">
      <strong>Controls</strong>
      <label>Code Suffix</label>
      <input id="codeSuffix" class="form-control form-control-sm" value="2507-02810-0011-0" />
      <label>Term Suffix</label>
      <input id="termSuffix" class="form-control form-control-sm" value="10122" />
      <label>Sam Id</label>
      <input id="samIdInput" class="form-control form-control-sm" value="05220409" />
      <label>Ticket Price</label>
      <input id="priceInput" type="number" class="form-control form-control-sm" value="120" />
      <button id="downloadBtn" class="btn btn-dark btn-sm mt-3">Download PDF & PNG</button>
    </div>
  </aside>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const topCodeEl = document.getElementById('topCode');
const pDateEl = document.getElementById('pDate');
const pTimeEl = document.getElementById('pTime');
const untilDateEl = document.getElementById('untilDate');
const untilTimeEl = document.getElementById('untilTime');
const kioskNoEl = document.getElementById('kioskNo');
const samIdEl = document.getElementById('samId');
const ticketPriceEl = document.getElementById('ticketPrice');
const ticketPriceTextEl = document.getElementById('ticketPriceText');

const codeSuffixInput = document.getElementById('codeSuffix');
const termSuffixInput = document.getElementById('termSuffix');
const samIdInput = document.getElementById('samIdInput');
const priceInput = document.getElementById('priceInput');

const TOP_PREFIX = '32-001-';
const KIOSK_PREFIX = '1230000001/';

function applyEdits() {
  topCodeEl.textContent = TOP_PREFIX + codeSuffixInput.value;
  kioskNoEl.textContent = KIOSK_PREFIX + termSuffixInput.value;
  samIdEl.textContent = samIdInput.value;
  ticketPriceEl.textContent = priceInput.value;
  ticketPriceTextEl.textContent = priceInput.value;
}
[codeSuffixInput, termSuffixInput, samIdInput, priceInput].forEach(i => i.addEventListener('input', applyEdits));
applyEdits();

function tick() {
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  pDateEl.textContent = `Purchase Date: ${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;
  pTimeEl.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  const plus2 = new Date(now.getTime() + 2*60*60*1000);
  untilDateEl.textContent = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;
  untilTimeEl.textContent = `${pad(plus2.getHours())}:${pad(plus2.getMinutes())}`;
}
tick();
setInterval(tick, 1000);

document.getElementById('downloadBtn').addEventListener('click', async () => {
  const receipt = document.getElementById('pdfRoot');

  // temporarily show (force render)
  receipt.style.visibility = "visible";
  receipt.style.position = "absolute";
  receipt.style.left = "-9999px"; // screen se bahar

  // wait ek repaint ka
  await new Promise(r => setTimeout(r, 100));

  const canvas = await html2canvas(receipt, { scale: 2, useCORS:true });
  const imgData = canvas.toDataURL('image/png');

  // PDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'px', [849,1280]);
  pdf.addImage(imgData, 'PNG', 0, 0, 849, 1280);
  pdf.save('ticket.pdf');

  // PNG
  canvas.toBlob(blob => {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'ticket.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }, 'image/png');

  // hide again
  receipt.style.visibility = "hidden";
});

</script>
</body>
</html>