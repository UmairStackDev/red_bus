<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <style>
    body {
      font-family: "Courier New", Courier, monospace;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: auto;
      min-height: 100vh;
      gap: 20px;
    }

    .pdf {
      width: 330px;
      height: 450px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #fff;
      border: 1px solid #ddd;
    }

    .top_code {
      font-size: 12px;
      font-weight: thin;  
      margin: 5px 0;
      padding: 5px 10px;
      letter-spacing: 1px;
    }

    img {
      width: auto;
      height: 170px;
    }

    .price {
      text-align: center;
      padding-top: 17px;
    }

    .price p {
      margin: 2px 0;
      line-height: 0.8;
    }

    .pera_ticket {
      margin: 5px 0;
      padding: 5px 10px;
    }

    .time {
      letter-spacing: 1px;
    }

    .details {
      padding-right: 15px;
      padding-top: 20px;
      margin: 2px 0;
      line-height: 0;
    }

    .details p {
      font-size: 12px;
      font-weight: normal;
    }

    /* control panel (PDF me render nahi hoga) */
    .controls {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 280px
    }

    .controls label {
      font-size: 12px;
      margin-top: 6px
    }
  </style>
</head>

<body>

  <!-- RECEIPT (PDF/Image area) -->
  <main>
    <div class="pdf" id="pdfRoot">
      <p class="top_code" id="topCode">
        32-001-2507-02810-0011-0
      </p>
      <img src="./img/qrcode.jpeg" alt="">
      <div class="price">
        <p style="font-size: 16px; font-weight: bold;">120
          <span style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 400;">PKR</span>
        </p>
        <p style="font-size: 12px; font-weight: normal;" class="pera_ticket">120-Single Ticket Adult</p>
      </div>
      <div class="details">
        <p id="pDate">Purchase Date: 13/07/2025</p>
        <p id="pTime" class="time">08:17:15</p>
        <p>
          <span>Valid Until</span><span style="padding-left: 15px;">:</span>&nbsp;<span id="untilDate">13/07/2025</span>
          <span style="padding-left: 0px;" id="untilTime">10:17</span>
        </p>
        <p>
          <span>Sam Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="padding-left: 8px;">:</span>&nbsp;05220409
        </p>
        <p>
          <span>Kiosk/Term No</span><span style="padding-left: 1px;">:</span>&nbsp;<span id="kioskNo">1230000001/10122</span>
        </p>
      </div>
    </div>
  </main>

  <!-- SMALL CONTROL PANEL -->
  <aside class="controls">
    <div class="card p-3 shadow-sm">
      <strong>Controls</strong>
      <label class="form-label">Code Suffix (after 32-001-)</label>
      <input id="codeSuffix" class="form-control form-control-sm" value="2507-02810-0011-0" />

      <label class="form-label">Term Suffix (after 1230000001/)</label>
      <input id="termSuffix" class="form-control form-control-sm" value="10122" />

      <button id="downloadBtn" class="btn btn-dark btn-sm mt-3">Download PDF (591Ã—850)</button>
      <button id="downloadImgBtn" class="btn btn-primary btn-sm mt-2">Download Image</button>
      <small class="text-muted mt-2">Time live hai; Valid Until = +2 hours (no seconds).</small>
    </div>
  </aside>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // helpers
    const pad = n => String(n).padStart(2, '0');
    const fmtDate = d => `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
    const fmtTime = d => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const fmtTimeNoSec = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;

    // elements
    const topCodeEl = document.getElementById('topCode');
    const pDateEl = document.getElementById('pDate');
    const pTimeEl = document.getElementById('pTime');
    const untilDateEl = document.getElementById('untilDate');
    const untilTimeEl = document.getElementById('untilTime');
    const kioskNoEl = document.getElementById('kioskNo');

    const codeSuffixInput = document.getElementById('codeSuffix');
    const termSuffixInput = document.getElementById('termSuffix');

    const TOP_PREFIX = '32-001-';
    const KIOSK_PREFIX = '1230000001/';

    // update editable parts
    const applyEdits = () => {
      topCodeEl.textContent = TOP_PREFIX + (codeSuffixInput.value || '');
      kioskNoEl.textContent = KIOSK_PREFIX + (termSuffixInput.value || '');
    };
    codeSuffixInput.addEventListener('input', applyEdits);
    termSuffixInput.addEventListener('input', applyEdits);
    applyEdits();

    // live clock + validity
    function tick() {
      const now = new Date();
      pDateEl.textContent = `Purchase Date: ${fmtDate(now)}`;
      pTimeEl.textContent = fmtTime(now);

      const plus2 = new Date(now.getTime() + 2 * 60 * 60 * 1000);
      untilDateEl.textContent = fmtDate(now);
      untilTimeEl.textContent = fmtTimeNoSec(plus2);
    }
    tick();
    setInterval(tick, 1000);

    // PNG Download
    document.getElementById('downloadImgBtn').addEventListener('click', async () => {
      const pdfEl = document.getElementById('pdfRoot');
      const canvas = await html2canvas(pdfEl, { scale: 2 });
      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = 'ticket.png';
      link.click();
    });

    // PDF Download (same design via screenshot)
    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const pdfEl = document.getElementById('pdfRoot');
      const canvas = await html2canvas(pdfEl, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "portrait",
        unit: "px",
        format: [591, 850]
      });

      doc.addImage(imgData, 'PNG', 0, 0, 591, 850);
      doc.save('ticket.pdf');
    });
  </script>
</body>
</html>
